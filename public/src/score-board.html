<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="./score-frame.html">
<link rel="import" href="./last-frame.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">


<dom-module id="score-board">
    <template>
        <style>
            [wrapper] {
                @apply --layout-horizontal;
            }
            #rollsInput{
                /* opacity: 0 ; */
            }
        </style>
        <div wrapper>
            <template id="domRepeat" list is="dom-repeat" items="{{_computeFrameValues(rolls)}}" as="frame">
                <score-frame id='frame_[[index]]' frame-number=[[index]] score1=[[frame.score1]] score2=[[frame.score2]] score-result=[[frame.result]]> </score-frame>
            </template>
            <last-frame id='frame_9' frame-number='9' score1='[[lastScore1]]' score2='[[lastScore2]]' score3='[[lastScore3]]' score-result='[[totalScore]]'>  </last-frame>
        </div>
        <paper-input id='rollsInput' value='{{rolls}}'>  </paper-input>
    </template>
    <script>
        class ScoreBoard extends Polymer.Element {
            static get is() {
                return 'score-board';
            }
            static get properties() {
                return {
                    rolls: {
                        type: String,
                        value: ''
                    },
                    frameValues: {
                        type: Array
                    },
                    selected:{type:Boolean,value:false,observer:'_updateSelection'},
                    currentRoll:{type:Number,value:0},
                    selectedFrame:{type:Number,value:0},
                    lastScore1:{type:String,value:""},
                    lastScore2:{type:String,value:""},
                    lastScore3:{type:String,value:""},
                    totalScore:{type:String,value:""}
                }
            }
            constructor() {
                super();
            }
            _updateSelection(selected) {
                Polymer.RenderStatus.afterNextRender(this, function() {
                    if(!selected)
                        this.shadowRoot.querySelector('#frame_'+this.selectedFrame).selected = false ; 
                    else{
                        this.shadowRoot.querySelector('#frame_'+this.selectedFrame).selected = true ; 
                        this.$.rollsInput.focus() ;
                    }
                });
            }
            _isDigit(ch) {
                if (ch >= '0' && ch <= '9')
                    return true;
                return false;
            }
            _computeFrameValues(rolls) {
                // use backend
                let result = app___computeScore(rolls) ;
                let frameScores = result.frameScores ; 
                let res = [];
                let frame = 0;
                let frameObject = {score1:"",score2:"",score3:"",result:""};
                let frameValues = [];
                
                for (let i = 0; i < rolls.length; i++) {
                    if (rolls[i] !== 'X' && rolls[i] !== '/') { // dÃ­gitos
                        frame += 0.5 ;
                        if (frameObject.score1 === "")
                            frameObject.score1 = rolls[i];
                        else if (frameObject.score2 === "")
                            frameObject.score2 = rolls[i];
                        else if(frameObject.score3 === "")
                            frameObject.score3 = rolls[i] ; 
                    } else if (rolls[i] === '/') { // spare
                        frame += 0.5;
                        if(frameObject.score2 === "")
                            frameObject.score2 = '/' ;  
                        else if(frameObject.score3 === "")
                            frameObject.score3 = '/' ; 
                    } else { // strike 
                        frame += 1;
                        if(frameObject.score1 === "")
                            frameObject.score1 = 'X' ;
                        else if(frameObject.score2 === "")
                            frameObject.score2 = 'X' ;  
                        else if(frameObject.score3 === "")
                            frameObject.score3 = 'X' ; 
                    }
                    if (Number.isInteger(frame) && frame < 10) {
                        frameObject.result = frameScores[frame-1] ;
                        frameValues.push(frameObject);
                        frameObject = {score1:"",score2:"",score3:"",result:""}
                    }
                }
                if(frame >= 9){
                    this.lastScore1 = frameObject.score1  ;
                    this.lastScore2 = frameObject.score2 ;
                    this.lastScore3 = frameObject.score3 ;
                    if(this._isDigit(this.lastScore2) || this.lastScore2 === "-"){
                        this.done = true ; 
                        this.totalScore = result.score ;
                        this.shadowRoot.querySelector('#frame_'+this.selectedFrame).selected = false ; 
                        this.dispatchEvent(new CustomEvent('rolls-computed', { bubbles: true, composed: true }));
                    }
                    else{
                        this.totalScore = "" ; 
                        this.done = false ; 
                    }
                }
                else if (frame < 9){
                    this.done = false ; 
                    this.totalScore = "" ; 
                    this.lastScore1 = "" ;
                    this.lastScore2 = "" ;
                    this.lastScore3 = "" ;
                    frameValues.push(frameObject) ; 
                    for(let i = 0 ; i < 8-frame ; i ++ ){
                        frameValues.push({
                            score1:"",
                            score2:"",
                            score3:"",
                            result:""
                        }) ; 
                    }
                }
                Polymer.RenderStatus.afterNextRender(this, function() {
                    if(!this.done){
                        this.shadowRoot.querySelector('#frame_'+this.selectedFrame).selected = false ; 
                        this.selectedFrame = Math.floor(frame) ;
                        this.selectedFrame = Math.min(this.selectedFrame,9) ;
                        this.shadowRoot.querySelector('#frame_'+this.selectedFrame).selected = true ; 
                        this.dispatchEvent(new CustomEvent('rolls-computed', { bubbles: true, composed: true }));
                    }
                });
                return frameValues ;
            }
        }
        customElements.define('score-board', ScoreBoard);
    </script>
</dom-module>